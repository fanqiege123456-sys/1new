# 文件上传功能修复说明

## 问题描述
用户反馈：创建仓库功能正常，但上传文件时出现 500 错误。

## 错误信息分析
从后端日志可以看到两个主要错误：
1. `GitHub API error: path cannot start with a slash`
2. `GitHub API error: Not Found` (在尝试 GET 文件时)

## 根本原因

### 问题 1: 双重 Base64 编码
**前端** (`git-web/services/githubService.ts`):
- 在 `uploadFile()` 方法中，使用 `readFileAsBase64()` 将文件转换为 base64
- 发送给后端的 `content` 字段已经是 base64 编码的字符串

**后端** (`git-net-disk/internal/github/github.go`):
- 在 `CreateOrUpdateFile()` 方法中，又对已经是 base64 的内容再次进行 base64 编码
- 导致发送给 GitHub API 的内容是双重编码的，GitHub 无法正确解析

### 问题 2: Gin 路由参数包含前导斜杠
**Gin 框架行为**:
- 使用 `*path` 通配符参数时，Gin 会保留路径中的前导斜杠
- 例如：`/api/file/:owner/:repo/*path` 匹配 `/api/file/user/repo/folder/file.txt`
- `c.Param("path")` 返回 `/folder/file.txt` (注意开头的 `/`)

**GitHub API 要求**:
- GitHub Contents API 不接受以斜杠开头的路径
- 正确格式：`folder/file.txt`
- 错误格式：`/folder/file.txt`

## 修复方案

### 1. 移除后端的重复编码
**文件**: `git-net-disk/internal/github/github.go`

**修改**: 在 `CreateOrUpdateFile()` 方法中，直接使用前端传来的 base64 内容

```go
// 前端已经发送了 base64 编码的内容，直接使用
// 不需要再次编码
fmt.Printf("[DEBUG] CreateOrUpdateFile - owner: %s, repo: %s, path: %s\n", owner, repo, path)
fmt.Printf("[DEBUG] Content length: %d bytes\n", len(content))

requestBody := CreateFileRequest{
    Message: message,
    Content: content, // 直接使用前端传来的 base64 内容
    Branch:  branch,
}
```

### 2. 移除路径前导斜杠
**文件**: `git-net-disk/api/files.go`

**修改**: 在所有文件操作方法中添加路径清理

```go
owner := c.Param("owner")
repo := c.Param("repo")
path := c.Param("path")

// Gin 的 *path 参数会包含开头的斜杠，需要移除
path = strings.TrimPrefix(path, "/")
```

**应用到以下方法**:
- `ListFiles()` - 列出文件
- `GetFileContent()` - 获取文件内容
- `CreateOrUpdateFile()` - 创建或更新文件
- `DeleteFile()` - 删除文件

### 3. 添加调试日志
在后端添加了详细的调试日志：
- API 层：记录接收到的 owner, repo, path 参数
- API 层：记录请求体的 message, content 长度, branch
- GitHub 客户端层：记录发送给 GitHub 的参数和 Authorization 头

## 测试步骤

1. **重启后端服务**
   ```bash
   cd git-net-disk
   # 先停止旧进程（如果在运行）
   # 然后启动新进程
   go run main.go
   ```

2. **测试文件上传**
   - 在前端创建一个新仓库（或使用现有仓库）
   - 拖拽文件到文件浏览器
   - 观察后端控制台的调试日志
   - 确认文件成功上传到 GitHub

3. **验证结果**
   - 在 GitHub 网站上查看仓库，确认文件已上传
   - 在前端刷新文件列表，确认文件显示正确

## 预期结果
- 文件上传成功，返回 200 或 201 状态码
- 后端日志显示：
  ```
  [DEBUG] CreateOrUpdateFile API - owner: xxx repo: xxx path: folder/file.txt
  [DEBUG] Request - Message: Upload file.txt via GitNetDisk Content length: xxxx Branch: 
  [DEBUG] CreateOrUpdateFile - owner: xxx, repo: xxx, path: folder/file.txt
  [DEBUG] Content length: xxxx bytes
  [DEBUG] Sending Authorization header to GitHub: token ghp_xxx
  ```
- GitHub 仓库中可以看到上传的文件

## 路径说明

### URL 结构
```
PUT /api/file/:owner/:repo/*path
```

### 示例
上传文件到 `folder/subfolder/file.txt`:
- 前端发送: `PUT /api/file/username/reponame/folder/subfolder/file.txt`
- Gin 解析:
  - `:owner` = `username`
  - `:repo` = `reponame`
  - `*path` = `/folder/subfolder/file.txt` (注意前导斜杠)
- 清理后: `path` = `folder/subfolder/file.txt`
- 发送给 GitHub: `https://api.github.com/repos/username/reponame/contents/folder/subfolder/file.txt`

## 其他注意事项

### 前端已有的优化
前端代码已经包含以下优化（之前的修复）：
1. 移除了上传前的文件存在性检查（避免不必要的 GET 请求）
2. 路径清理：`path = path.replace(/^\/+/, '');`
3. 调试日志：在 `handleUploadFiles()` 中记录上传路径

### GitHub API 要求
- Content 必须是 base64 编码的字符串
- 路径不应该以 `/` 开头
- Message 是必需的（commit message）
- 如果文件已存在且需要更新，必须提供 SHA（但对于新文件不需要）

## 修改的文件清单
1. `git-net-disk/internal/github/github.go` - 移除双重编码，添加调试日志
2. `git-net-disk/api/files.go` - 在所有文件操作中添加路径前导斜杠清理和调试日志

