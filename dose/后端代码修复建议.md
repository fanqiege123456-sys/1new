# åç«¯ä»£ç ä¿®å¤å»ºè®®

## ğŸ› é—®é¢˜åˆ†æ

Token æœ¬èº«æ˜¯æœ‰æ•ˆçš„ï¼ˆå·²é€šè¿‡ curl éªŒè¯ï¼‰ï¼Œä½†åç«¯è°ƒç”¨ GitHub API æ—¶è¿”å› "Bad credentials"ã€‚

## ğŸ” éœ€è¦æ·»åŠ è°ƒè¯•æ—¥å¿—

åœ¨ `git-net-disk/internal/github/github.go` çš„ `setRequestHeaders` å‡½æ•°ä¸­æ·»åŠ æ—¥å¿—ï¼š

```go
// setRequestHeaders è®¾ç½®è¯·æ±‚å¤´
func (c *Client) setRequestHeaders(req *http.Request) {
    req.Header.Set("Accept", "application/vnd.github.v3+json")
    req.Header.Set("User-Agent", "GitNetDisk")
    if c.token != "" {
        authHeader := fmt.Sprintf("token %s", c.token)
        req.Header.Set("Authorization", authHeader)
        
        // æ·»åŠ è°ƒè¯•æ—¥å¿—
        log.Printf("[DEBUG] Setting Authorization header: %s", authHeader)
        log.Printf("[DEBUG] Token length: %d", len(c.token))
        log.Printf("[DEBUG] Token first 10 chars: %s", c.token[:min(10, len(c.token))])
    }
}

func min(a, b int) int {
    if a < b {
        return a
    }
    return b
}
```

## ğŸ”§ å¯èƒ½çš„é—®é¢˜

### é—®é¢˜ 1: Token ä¸­æœ‰éšè—å­—ç¬¦

Token åœ¨ä¼ é€’è¿‡ç¨‹ä¸­å¯èƒ½åŒ…å«äº†æ¢è¡Œç¬¦ã€ç©ºæ ¼ç­‰éšè—å­—ç¬¦ã€‚

**ä¿®å¤æ–¹æ¡ˆ**ï¼šåœ¨ `repos.go` ä¸­æ¸…ç† token

```go
// ListRepositories åˆ—å‡ºç”¨æˆ·çš„ä»“åº“
func (h *ReposHandler) ListRepositories(c *gin.Context) {
    // ä»è¯·æ±‚å¤´è·å–token
    authHeader := c.GetHeader("Authorization")
    var userToken string
    
    // å¤„ç†ä¸¤ç§æ ¼å¼çš„ Authorization å¤´
    if authHeader != "" {
        // æ ¼å¼1: token ghp_xxxxxxxx
        if len(authHeader) > 7 && authHeader[:7] == "token " {
            userToken = authHeader[7:]
        } else {
            // æ ¼å¼2: ghp_xxxxxxxx (ç›´æ¥æ˜¯tokenå€¼)
            userToken = authHeader
        }
    }
    
    // æ¸…ç† tokenï¼ˆå»é™¤å¯èƒ½çš„ç©ºæ ¼å’Œæ¢è¡Œç¬¦ï¼‰
    userToken = strings.TrimSpace(userToken)
    
    // æ·»åŠ è°ƒè¯•æ—¥å¿—
    log.Printf("[DEBUG] Received Authorization: %s", authHeader)
    log.Printf("[DEBUG] Extracted token: %s", userToken)
    log.Printf("[DEBUG] Token length: %d", len(userToken))

    if userToken == "" {
        c.JSON(401, gin.H{"error": "Missing authentication token"})
        return
    }

    // åˆ›å»ºä¸´æ—¶GitHubå®¢æˆ·ç«¯
    client, err := github.NewClient(userToken, h.proxyConfig)
    if err != nil {
        c.JSON(500, gin.H{"error": "Failed to create GitHub client"})
        return
    }

    repos, err := client.ListRepositories()
    if err != nil {
        c.Error(err)
        return
    }

    middleware.Success(c, repos, "Repositories listed successfully")
}
```

### é—®é¢˜ 2: ä»£ç†é…ç½®é—®é¢˜

å¦‚æœé…ç½®äº†ä»£ç†ï¼Œå¯èƒ½ä»£ç†æœåŠ¡å™¨æœ‰é—®é¢˜ã€‚

**ä¿®å¤æ–¹æ¡ˆ**ï¼šä¸´æ—¶ç¦ç”¨ä»£ç†æµ‹è¯•

åœ¨ `main.go` æˆ–å¯åŠ¨ä»£ç ä¸­ï¼š

```go
// åˆ›å»ºç©ºçš„ä»£ç†é…ç½®ï¼ˆä¸ä½¿ç”¨ä»£ç†ï¼‰
proxyConfig := proxy.ProxyConfig{
    ProxyURL: "",  // ç©ºå­—ç¬¦ä¸²è¡¨ç¤ºä¸ä½¿ç”¨ä»£ç†
}
```

### é—®é¢˜ 3: User-Agent é—®é¢˜

æŸäº›æƒ…å†µä¸‹ï¼ŒGitHub API å¯¹ User-Agent æœ‰è¦æ±‚ã€‚

**ä¿®å¤æ–¹æ¡ˆ**ï¼šä½¿ç”¨æ›´è¯¦ç»†çš„ User-Agent

```go
func (c *Client) setRequestHeaders(req *http.Request) {
    req.Header.Set("Accept", "application/vnd.github.v3+json")
    req.Header.Set("User-Agent", "GitNetDisk/1.0 (Go-http-client)")  // æ›´è¯¦ç»†
    if c.token != "" {
        req.Header.Set("Authorization", fmt.Sprintf("token %s", c.token))
    }
}
```

## ğŸ¯ æ¨èçš„ä¿®å¤æ­¥éª¤

### æ­¥éª¤ 1: æ·»åŠ è¯¦ç»†æ—¥å¿—

åœ¨ä»¥ä¸‹ä½ç½®æ·»åŠ æ—¥å¿—ï¼š

1. `repos.go` - æ¥æ”¶åˆ°çš„ Authorization å¤´
2. `repos.go` - æå–åçš„ token
3. `github.go` - è®¾ç½®è¯·æ±‚å¤´æ—¶çš„ Authorization

### æ­¥éª¤ 2: æ¸…ç† token

åœ¨ `repos.go` ä¸­æ·»åŠ  `strings.TrimSpace(userToken)`

### æ­¥éª¤ 3: é‡å¯åç«¯å¹¶æŸ¥çœ‹æ—¥å¿—

```bash
cd git-net-disk
go run main.go
```

ç„¶ååœ¨å‰ç«¯ç™»å½•ï¼ŒæŸ¥çœ‹åç«¯æ§åˆ¶å°è¾“å‡ºçš„æ—¥å¿—ã€‚

### æ­¥éª¤ 4: å¯¹æ¯”æ—¥å¿—

å¯¹æ¯”ä»¥ä¸‹å†…å®¹ï¼š
- å‰ç«¯å‘é€çš„ Authorization
- åç«¯æ¥æ”¶åˆ°çš„ Authorization
- åç«¯æå–çš„ token
- åç«¯å‘é€ç»™ GitHub çš„ Authorization

## ğŸ“ å®Œæ•´çš„ä¿®å¤ä»£ç 

### repos.go

```go
package api

import (
	"git-net-disk/api/middleware"
	"git-net-disk/internal/github"
	"git-net-disk/internal/proxy"
	"log"
	"strings"

	"github.com/gin-gonic/gin"
)

// ReposHandler ä»“åº“ç›¸å…³çš„ API å¤„ç†å™¨
type ReposHandler struct {
	proxyConfig proxy.ProxyConfig
}

// NewReposHandler åˆ›å»ºæ–°çš„ä»“åº“å¤„ç†å™¨
func NewReposHandler(token string, proxyConfig proxy.ProxyConfig) (*ReposHandler, error) {
	return &ReposHandler{
		proxyConfig: proxyConfig,
	}, nil
}

// ListRepositories åˆ—å‡ºç”¨æˆ·çš„ä»“åº“
func (h *ReposHandler) ListRepositories(c *gin.Context) {
	// ä»è¯·æ±‚å¤´è·å–token
	authHeader := c.GetHeader("Authorization")
	log.Printf("[DEBUG] Received Authorization header: %s", authHeader)
	
	var userToken string
	
	// å¤„ç†ä¸¤ç§æ ¼å¼çš„ Authorization å¤´
	if authHeader != "" {
		// æ ¼å¼1: token ghp_xxxxxxxx
		if len(authHeader) > 7 && authHeader[:7] == "token " {
			userToken = authHeader[7:]
		} else {
			// æ ¼å¼2: ghp_xxxxxxxx (ç›´æ¥æ˜¯tokenå€¼)
			userToken = authHeader
		}
	}
	
	// æ¸…ç† tokenï¼ˆå»é™¤å¯èƒ½çš„ç©ºæ ¼å’Œæ¢è¡Œç¬¦ï¼‰
	userToken = strings.TrimSpace(userToken)
	
	log.Printf("[DEBUG] Extracted token: %s", userToken)
	log.Printf("[DEBUG] Token length: %d", len(userToken))

	if userToken == "" {
		c.JSON(401, gin.H{"error": "Missing authentication token"})
		return
	}

	// åˆ›å»ºä¸´æ—¶GitHubå®¢æˆ·ç«¯
	client, err := github.NewClient(userToken, h.proxyConfig)
	if err != nil {
		log.Printf("[ERROR] Failed to create GitHub client: %v", err)
		c.JSON(500, gin.H{"error": "Failed to create GitHub client"})
		return
	}

	repos, err := client.ListRepositories()
	if err != nil {
		log.Printf("[ERROR] Failed to list repositories: %v", err)
		c.Error(err)
		return
	}

	middleware.Success(c, repos, "Repositories listed successfully")
}

// ... å…¶ä»–ä»£ç ä¿æŒä¸å˜
```

### github.go

```go
// setRequestHeaders è®¾ç½®è¯·æ±‚å¤´
func (c *Client) setRequestHeaders(req *http.Request) {
	req.Header.Set("Accept", "application/vnd.github.v3+json")
	req.Header.Set("User-Agent", "GitNetDisk/1.0")
	if c.token != "" {
		authHeader := fmt.Sprintf("token %s", c.token)
		req.Header.Set("Authorization", authHeader)
		
		// æ·»åŠ è°ƒè¯•æ—¥å¿—
		log.Printf("[DEBUG] Setting Authorization: %s", authHeader)
		log.Printf("[DEBUG] Request URL: %s", req.URL.String())
	}
}
```

## ğŸ§ª æµ‹è¯•

ä¿®æ”¹ä»£ç åï¼š

1. é‡å¯åç«¯
2. åœ¨å‰ç«¯ç™»å½•
3. æŸ¥çœ‹åç«¯æ§åˆ¶å°çš„æ—¥å¿—è¾“å‡º
4. å°†æ—¥å¿—å‘ç»™æˆ‘åˆ†æ

æ—¥å¿—åº”è¯¥åŒ…å«ï¼š
```
[DEBUG] Received Authorization header: token ghp_xxx
[DEBUG] Extracted token: ghp_xxx
[DEBUG] Token length: 40
[DEBUG] Setting Authorization: token ghp_xxx
[DEBUG] Request URL: https://api.github.com/user/repos
```

å¦‚æœ token é•¿åº¦ä¸æ˜¯ 40ï¼ˆæˆ– 93 å¯¹äº fine-grained tokenï¼‰ï¼Œè¯´æ˜æœ‰é—®é¢˜ã€‚
