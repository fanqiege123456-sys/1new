# åç«¯è°ƒè¯•æŒ‡å—

## ğŸ› å½“å‰é—®é¢˜

**é”™è¯¯**: `GET http://localhost:3000/api/repos` è¿”å› 500 Internal Server Error

**åŸå› **: åç«¯åœ¨å¤„ç† GitHub API è¯·æ±‚æ—¶å‡ºé”™

---

## ğŸ” éœ€è¦æ£€æŸ¥çš„åœ°æ–¹

### 1. åç«¯æ—¥å¿—

è¯·æŸ¥çœ‹åç«¯æ§åˆ¶å°çš„å®Œæ•´é”™è¯¯æ—¥å¿—ï¼Œåº”è¯¥åŒ…å«ï¼š
- GitHub API è¿”å›çš„é”™è¯¯ä¿¡æ¯
- å †æ ˆè·Ÿè¸ª
- è¯·æ±‚è¯¦æƒ…

### 2. GitHub API è°ƒç”¨

åç«¯ä»£ç åº”è¯¥ç±»ä¼¼è¿™æ ·ï¼š

```go
func (h *Handler) GetRepos(c *gin.Context) {
    // 1. è·å– Token
    token := c.GetHeader("Authorization")
    if token == "" {
        c.JSON(401, gin.H{"error": "Missing authentication token"})
        return
    }
    
    // 2. è°ƒç”¨ GitHub API
    req, err := http.NewRequest("GET", "https://api.github.com/user/repos?sort=updated&per_page=100", nil)
    if err != nil {
        c.JSON(500, gin.H{"error": err.Error()})
        return
    }
    
    // 3. è®¾ç½®è¯·æ±‚å¤´
    req.Header.Set("Authorization", token)  // ç›´æ¥ä½¿ç”¨ "token ghp_xxx"
    req.Header.Set("Accept", "application/vnd.github.v3+json")
    req.Header.Set("User-Agent", "GitNetDisk/1.0")
    
    // 4. å‘é€è¯·æ±‚
    client := &http.Client{Timeout: 30 * time.Second}
    resp, err := client.Do(req)
    if err != nil {
        c.JSON(500, gin.H{"error": err.Error()})
        return
    }
    defer resp.Body.Close()
    
    // 5. è¯»å–å“åº”
    body, err := io.ReadAll(resp.Body)
    if err != nil {
        c.JSON(500, gin.H{"error": err.Error()})
        return
    }
    
    // 6. æ£€æŸ¥ GitHub API å“åº”çŠ¶æ€
    if resp.StatusCode != 200 {
        c.JSON(resp.StatusCode, gin.H{
            "error": "GitHub API error",
            "status": resp.StatusCode,
            "body": string(body),
        })
        return
    }
    
    // 7. è§£æ JSON
    var repos []interface{}
    if err := json.Unmarshal(body, &repos); err != nil {
        c.JSON(500, gin.H{"error": err.Error()})
        return
    }
    
    // 8. è¿”å›ç»“æœ
    c.JSON(200, gin.H{
        "code": 200,
        "message": "Repositories listed successfully",
        "data": repos,
    })
}
```

---

## âš ï¸ å¸¸è§é”™è¯¯

### é”™è¯¯ 1: Token æ ¼å¼ä¸æ­£ç¡®

**é”™è¯¯ä»£ç **:
```go
// âŒ é”™è¯¯
req.Header.Set("Authorization", "Bearer " + token)

// âœ… æ­£ç¡®
req.Header.Set("Authorization", token)  // å‰ç«¯å·²ç»å‘é€ "token ghp_xxx"
```

### é”™è¯¯ 2: ç¼ºå°‘å¿…è¦çš„è¯·æ±‚å¤´

**å¿…é¡»åŒ…å«**:
```go
req.Header.Set("Accept", "application/vnd.github.v3+json")
req.Header.Set("User-Agent", "GitNetDisk/1.0")  // GitHub è¦æ±‚å¿…é¡»æœ‰ User-Agent
```

### é”™è¯¯ 3: CORS é…ç½®ä¸æ­£ç¡®

**éœ€è¦å…è®¸çš„è¯·æ±‚å¤´**:
```go
router.Use(cors.New(cors.Config{
    AllowOrigins:     []string{"http://localhost:5173"},
    AllowMethods:     []string{"GET", "POST", "PUT", "DELETE", "OPTIONS"},
    AllowHeaders:     []string{"Origin", "Content-Type", "Authorization"},
    ExposeHeaders:    []string{"Content-Length"},
    AllowCredentials: true,
    MaxAge:           12 * time.Hour,
}))
```

### é”™è¯¯ 4: æ²¡æœ‰å¤„ç† GitHub API é”™è¯¯

**åº”è¯¥æ£€æŸ¥ GitHub API çš„å“åº”çŠ¶æ€**:
```go
if resp.StatusCode != 200 {
    // è¯»å–é”™è¯¯ä¿¡æ¯
    body, _ := io.ReadAll(resp.Body)
    log.Printf("GitHub API error: %d - %s", resp.StatusCode, string(body))
    
    c.JSON(resp.StatusCode, gin.H{
        "error": "GitHub API error",
        "details": string(body),
    })
    return
}
```

---

## ğŸ§ª æµ‹è¯•æ­¥éª¤

### 1. æµ‹è¯• GitHub API ç›´æ¥è°ƒç”¨

ä½¿ç”¨ curl æµ‹è¯• GitHub API æ˜¯å¦æ­£å¸¸ï¼š

```bash
curl -H "Authorization: token YOUR_GITHUB_TOKEN" \
     -H "Accept: application/vnd.github.v3+json" \
     -H "User-Agent: GitNetDisk/1.0" \
     https://api.github.com/user/repos
```

å¦‚æœè¿™ä¸ªå‘½ä»¤æˆåŠŸè¿”å›ä»“åº“åˆ—è¡¨ï¼Œè¯´æ˜ Token æ˜¯æœ‰æ•ˆçš„ã€‚

### 2. æµ‹è¯•åç«¯æ¥å£

```bash
curl -H "Authorization: token YOUR_GITHUB_TOKEN" \
     http://localhost:3000/api/repos
```

æŸ¥çœ‹è¿”å›çš„é”™è¯¯ä¿¡æ¯ã€‚

### 3. æ·»åŠ è¯¦ç»†æ—¥å¿—

åœ¨åç«¯ä»£ç ä¸­æ·»åŠ æ—¥å¿—ï¼š

```go
func (h *Handler) GetRepos(c *gin.Context) {
    token := c.GetHeader("Authorization")
    log.Printf("Received token: %s", token)  // æ‰“å° tokenï¼ˆç”Ÿäº§ç¯å¢ƒè¦åˆ é™¤ï¼‰
    
    // ... è°ƒç”¨ GitHub API
    
    log.Printf("GitHub API response status: %d", resp.StatusCode)
    log.Printf("GitHub API response body: %s", string(body))
    
    // ... å¤„ç†å“åº”
}
```

---

## ğŸ“‹ æ£€æŸ¥æ¸…å•

- [ ] Token æ ¼å¼æ­£ç¡®ï¼ˆ`token ghp_xxx`ï¼‰
- [ ] è®¾ç½®äº† `User-Agent` è¯·æ±‚å¤´
- [ ] è®¾ç½®äº† `Accept` è¯·æ±‚å¤´
- [ ] CORS é…ç½®æ­£ç¡®
- [ ] æ­£ç¡®å¤„ç† GitHub API é”™è¯¯
- [ ] æ·»åŠ äº†è¯¦ç»†çš„é”™è¯¯æ—¥å¿—
- [ ] æµ‹è¯•äº† GitHub API ç›´æ¥è°ƒç”¨
- [ ] æ£€æŸ¥äº†åç«¯æ§åˆ¶å°æ—¥å¿—

---

## ğŸ”§ å¿«é€Ÿä¿®å¤å»ºè®®

### æ–¹æ¡ˆ 1: ç®€åŒ–åç«¯ä»£ç 

åˆ›å»ºä¸€ä¸ªæœ€ç®€å•çš„ä»£ç†ï¼š

```go
func (h *Handler) GetRepos(c *gin.Context) {
    // 1. è·å– token
    token := c.GetHeader("Authorization")
    
    // 2. åˆ›å»ºè¯·æ±‚
    req, _ := http.NewRequest("GET", "https://api.github.com/user/repos", nil)
    req.Header.Set("Authorization", token)
    req.Header.Set("Accept", "application/vnd.github.v3+json")
    req.Header.Set("User-Agent", "GitNetDisk")
    
    // 3. å‘é€è¯·æ±‚
    client := &http.Client{}
    resp, err := client.Do(req)
    if err != nil {
        c.JSON(500, gin.H{"error": err.Error()})
        return
    }
    defer resp.Body.Close()
    
    // 4. ç›´æ¥è½¬å‘å“åº”
    body, _ := io.ReadAll(resp.Body)
    
    var repos []interface{}
    json.Unmarshal(body, &repos)
    
    c.JSON(200, gin.H{
        "code": 200,
        "message": "success",
        "data": repos,
    })
}
```

### æ–¹æ¡ˆ 2: ä½¿ç”¨é€šç”¨ä»£ç†

åˆ›å»ºä¸€ä¸ªé€šç”¨çš„ GitHub API ä»£ç†ï¼š

```go
func ProxyGitHubAPI(c *gin.Context) {
    // è·å–ç›®æ ‡è·¯å¾„
    path := c.Param("path")
    githubURL := "https://api.github.com" + path
    
    // åˆ›å»ºè¯·æ±‚
    req, _ := http.NewRequest(c.Request.Method, githubURL, c.Request.Body)
    
    // å¤åˆ¶è¯·æ±‚å¤´
    for key, values := range c.Request.Header {
        for _, value := range values {
            req.Header.Add(key, value)
        }
    }
    
    // ç¡®ä¿å¿…è¦çš„è¯·æ±‚å¤´
    req.Header.Set("User-Agent", "GitNetDisk")
    
    // å‘é€è¯·æ±‚
    client := &http.Client{}
    resp, _ := client.Do(req)
    defer resp.Body.Close()
    
    // è½¬å‘å“åº”
    body, _ := io.ReadAll(resp.Body)
    c.Data(resp.StatusCode, resp.Header.Get("Content-Type"), body)
}

// è·¯ç”±é…ç½®
router.Any("/api/*path", ProxyGitHubAPI)
```

---

## ğŸ“ éœ€è¦æä¾›çš„ä¿¡æ¯

è¯·æä¾›ä»¥ä¸‹ä¿¡æ¯ä»¥ä¾¿è¿›ä¸€æ­¥è¯Šæ–­ï¼š

1. **åç«¯æ§åˆ¶å°çš„å®Œæ•´é”™è¯¯æ—¥å¿—**
2. **åç«¯ä½¿ç”¨çš„ Go ç‰ˆæœ¬**
3. **åç«¯çš„ CORS é…ç½®ä»£ç **
4. **åç«¯å¤„ç† `/api/repos` çš„å®Œæ•´ä»£ç **
5. **ä½¿ç”¨ curl æµ‹è¯• GitHub API çš„ç»“æœ**

æœ‰äº†è¿™äº›ä¿¡æ¯ï¼Œæˆ‘å¯ä»¥æ›´å‡†ç¡®åœ°å¸®ä½ è§£å†³é—®é¢˜ï¼
